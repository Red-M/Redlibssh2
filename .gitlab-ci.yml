
.build_process: &build_release_job
  image: docker:dind
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script: &build_release_script
    - apk add --no-cache bash git
    - git submodule update --init --recursive
    - chmod +x ./ci/gitlab/linux/build_manylinux.sh
    - ./ci/gitlab/linux/build_manylinux.sh
  artifacts:
    paths:
      - wheelhouse

stages:
  - test
  - build

release_mlinux_wheel:
  <<: *build_release_job
  stage: build
  only:
    refs:
      - master
      - schedules
      - /^release\/.*/
      - build_ci_testing

release_windows_wheel:
  <<: *build_release_job
  script:
    - apk add --no-cache bash git
    - git submodule update --init --recursive
    - chmod +x ./ci/gitlab/windows/build_windows.sh
    - ./ci/gitlab/windows/build_windows.sh
  stage: build
  only:
    refs:
      - master
      - schedules
      - /^release\/.*/
      - build_ci_testing

test_build:
  image: debian:stable
  stage: test
  script:
    - ./ci/gitlab/linux/install_deb_mirror.sh
    - apt update && apt install -y make curl wget openssh-client openssh-server git cmake libssl-dev zlib1g-dev
    - apt install -y python3 python3-dev python3-distutils
    - wget -O get-pip.py "https://bootstrap.pypa.io/get-pip.py"
    - python3 ./get-pip.py
    - git submodule update --init --recursive
    - pip3 install -U readme-renderer
    - python3 -m readme_renderer ./README.rst -o /tmp/README.html
    - python3 ./setup.py sdist

#~ tests_py3.5:
  #~ <<: *global_config
  #~ image: debian:9
  #~ script:
  #~ - ./tests/scripts/install_root.sh GITLAB 3 5
  #~ - ./tests/scripts/install.sh GITLAB 3 5
  #~ - ./tests/scripts/test.sh GITLAB 3 5
  #~ artifacts:
    #~ paths:
    #~ - htmlcov
  #~ only:
  #~ - master
