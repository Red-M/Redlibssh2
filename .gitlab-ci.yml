
.build_refs: &build_refs
  only:
    refs:
      - master
      - schedules
      - /^release\/.*/
      - build_ci_testing

.build_linux_process: &build_linux_release_job
  image: docker:dind
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script: &build_linux_release_script
    - apk add --no-cache bash git
    - git submodule update --init --recursive
    - chmod +x ./ci/gitlab/linux/build_manylinux.sh
    - ./ci/gitlab/linux/build_manylinux.sh
  artifacts:
    paths:
      - wheelhouse

.build_osx_process: &build_osx_release_job
  tags:
    - osx
  variables: &build_osx_release_variables
    SYSTEM_LIBSSH2: 1
  script: &build_osx_release_script
    - git submodule update --init --recursive
    - brew cleanup
    - brew update
    - brew install cmake ccache
    - brew outdated openssl || brew upgrade openssl || echo "y"
    - brew link --overwrite python@3.9 || brew install python@3.9 || brew link --overwrite python@3.9
    - which python3
    - python3 -c "from __future__ import print_function; import ssl; from platform import python_version; print(ssl.OPENSSL_VERSION); print(python_version())"
    - sudo ./ci/install-ssh2.sh
    - sudo chown -R $(whoami) ./src
    - rm ./src/CMakeCache.txt
    - cp /usr/local/lib/libssh2* .
    - mkdir -p wheelhouse
    - ln -s ./wheelhouse ./wheels
    - ./ci/travis/pyenv-wheel.sh
  artifacts:
    paths:
      - wheelhouse

stages:
  - test
  - build

release_mlinux_wheel:
  <<: *build_linux_release_job
  <<: *build_refs
  stage: build

release_osx_wheel:
  <<: *build_osx_release_job
  <<: *build_refs
  stage: build

#~ release_windows_wheel:
  #~ <<: *build_release_job
  #~ script:
    #~ - apk add --no-cache bash git
    #~ - git submodule update --init --recursive
    #~ - chmod +x ./ci/gitlab/windows/build.sh
    #~ - ./ci/gitlab/windows/build.sh
  #~ stage: build
  #~ only:
    #~ refs:
      #~ - master
      #~ - schedules
      #~ - /^release\/.*/
      #~ - build_ci_testing

test_build:
  image: debian:stable
  stage: test
  script:
    - ./ci/gitlab/linux/install_deb_mirror.sh
    - apt update && apt install -y make curl wget openssh-client openssh-server git cmake libssl-dev zlib1g-dev
    - apt install -y python3 python3-dev python3-distutils
    - wget -O get-pip.py "https://bootstrap.pypa.io/get-pip.py"
    - python3 ./get-pip.py
    - git submodule update --init --recursive
    - pip3 install -U readme-renderer
    - python3 -m readme_renderer ./README.rst -o /tmp/README.html
    - python3 ./setup.py sdist

test_build_latest_libssh2:
  image: debian:stable
  stage: test
  script:
    - ./ci/gitlab/linux/install_deb_mirror.sh
    - apt update && apt install -y make curl wget openssh-client openssh-server git cmake libssl-dev zlib1g-dev
    - apt install -y python3 python3-dev python3-distutils
    - wget -O get-pip.py "https://bootstrap.pypa.io/get-pip.py"
    - python3 ./get-pip.py
    - pip3 install -U readme-renderer
    - python3 -m readme_renderer ./README.rst -o /tmp/README.html
    - git submodule update --init --recursive
    - cd ./libssh2
    - git checkout master
    - git pull
    - cd ../
    - python3 ./setup.py sdist

#~ tests_py3.5:
  #~ <<: *global_config
  #~ image: debian:9
  #~ script:
  #~ - ./tests/scripts/install_root.sh GITLAB 3 5
  #~ - ./tests/scripts/install.sh GITLAB 3 5
  #~ - ./tests/scripts/test.sh GITLAB 3 5
  #~ artifacts:
    #~ paths:
    #~ - htmlcov
  #~ only:
  #~ - master

test_osx:
  stage: test
  variables:
    <<: *build_osx_release_variables
    PYENV: 3.7.11
  script: [*build_osx_release_script]
  tags:
    - osx
